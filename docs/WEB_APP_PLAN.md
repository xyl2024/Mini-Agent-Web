# Mini Agent Web 增强计划

## 背景

用户希望将 CLI 程序的交互体验带到 Web 浏览器上。当前项目：
- 纯 Python CLI 应用（使用 prompt_toolkit）
- 核心是 Agent 循环：LLM 调用 + 工具执行
- 无 Web 前端

## 方案：FastAPI + SQLite 数据库 + WebSocket

用户选择了 数据库 + WebSocket 方案，兼顾实时性与稳定性。

### 技术栈

- **后端**：FastAPI + Uvicorn + WebSocket
- **数据库**：SQLite（内置，无需额外安装）
- **前端**：后续再决定，先设计后端
- **通信**：HTTP（对话等接口） + WebSocket（实时推送）

### 设计架构

```
┌─────────────────────────────────────────────────────────┐
│  前后端通信流程 （示例）                                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  前端                              后端                  │
│    │                                │                  │
│    ├─ POST /agent/chat ───────────►│ 发送消息 (+ session_id) │
│    │◄──── 200 OK ──────────────────│                  │
│    │                                │                  │
│    │══════ WebSocket 连接 ═══════════│                  │
│    │                                │                  │
│    │◄──── {type: "message"} ────────│ 实时推送消息        │
│    │◄──── {type: "tool_call"} ──────│ 实时推送工具调用     │
│    │◄──── {type: "tool_result"}─────│ 工具执行结果        │
│    │◄──── {type: "done"} ───────────│ 本轮完成            │
│    │                                │                   │
└─────────────────────────────────────────────────────────┘
```

### 刷新页面恢复机制

刷新页面后，WebSocket 会断开，但可以通过数据库恢复连接：

```
┌─────────────────────────────────────────────────────────────┐
│  刷新页面后的恢复流程                                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 前端刷新 ──────────────────► 断开旧 WebSocket             │
│                                                             │
│  2. 页面重新加载 ◄───────────────── 前端重新渲染                │
│                                                             │
│  3. HTTP GET /agent/chat?session_id=xxx ──► 从数据库拉取历史消息 │
│     ◄─── {messages:[...]} ─ 完整历史！                       │
│                                                             │
│  4. WebSocket 重新连接 ──────────► 订阅后续消息                 │
│                                                             │
│  5. 继续接收实时推送 ◄───────────── 和刷新前无缝衔接！           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### WebSocket 消息格式（只是示例，不代表最终效果）

```python
# 客户端发送
{"type": "subscribe", "session_id": "xxx"}

# 服务端推送 - 助手消息
{"type": "message", "role": "assistant", "content": "我来帮你..."}

# 服务端推送 - 工具调用开始
{"type": "tool_call", "tool": "bash", "input": "ls -la"}

# 服务端推送 - 工具执行结果
{"type": "tool_result", "tool": "bash", "output": "file1.txt\nfile2.txt"}

# 服务端推送 - 会话完成
{"type": "done", "status": "done", "summary": "已完成"}

# 服务端推送 - 错误
{"type": "error", "message": "工具执行失败"}
```
